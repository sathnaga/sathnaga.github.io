---
layout: post
title: 'KVM: Libvirt: MultiVM Tests using Avocado Test Framework'
date: '2018-05-18T10:41:00.001+05:30'
author: Satheesh
tags:
- testing
- linux
- stress
- kvm
- avocado
- parallel
- automation
- libvirt
- powerpc
modified_time: '2018-05-18T21:11:50.346+05:30'
blogger_id: tag:blogger.com,1999:blog-3781127847171836973.post-8394254645119655395
blogger_orig_url: http://www.sathnaga86.com/2018/05/kvm-libvirt-multivm-tests-using-avocado.html
---

<div dir="ltr" style="text-align: left;" trbidi="on"><h2><b><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><i>This blog explains about my patch to avocado-vt framework to enable running multiple VM's through libvirt in a single test.</i></span></b></h2><div><i style="color: blue; font-size: small;"><br /></i><i style="color: blue; font-size: small;">Refer my previous blogs for introductions of avocado test framework.</i></div><div><h3 style="text-align: left;"><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><u><br /></u></span></h3><h3 style="text-align: left;"><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><u>Patches that are needed to support below tests:</u></span></h3><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><br /></span><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><a href="https://github.com/autotest/tp-libvirt" rel="nofollow" target="_blank">tp-libvirt</a>: <span style="color: blue;">*</span></span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">41434fbd Add multi vm cpu stress tests</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">ede3e1ac Fixup: stress functions args position</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><br /></span><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><a href="https://github.com/avocado-framework/avocado-vt" rel="nofollow" target="_blank">avocado-vt</a>: <span style="color: blue;">*</span></span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">2c3ad894 Add param to cleanup env</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">3723cb28 Library to generate stress events to guest</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">e6df69b7 Enable libvirt vm start in preprocess</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">44773144 Undefine libvirt vm using param during postprocess</span></div><div style="text-align: left;"><span style="color: blue; font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small; font-weight: normal;"><i><br /></i></span></div><div style="text-align: left;"><span style="color: blue; font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small; font-weight: normal;"><i>* - already merged in upstream.</i></span></div><h3 style="text-align: left;"><u><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">Steps to setup avocado in host and run Multi VM's libvirt tests:</span></u></h3><i><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">Make sure your host has all packages installed which are needed to run&nbsp;KVM guests through&nbsp;libvirt.</span></i><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><br /></span><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">Below tests results are from Fedora28 in IBM Power8 and Intel X86 hosts.</span><br /><div style="-webkit-text-stroke-width: 0px; color: black; font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-decoration-color: initial; text-decoration-style: initial; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;"></div><br /><div style="-webkit-text-stroke-width: 0px; color: black; font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-decoration-color: initial; text-decoration-style: initial; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;"><div style="margin: 0px;"><i style="color: blue; font-size: small;">Refer my previous blogs for installing and setting up of avocado test framework, lets right away jump to test runs..</i></div></div><div><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><br /></span><span style="color: blue; font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;"><i>Running tests...</i></span><br /><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><u><i>Result on IBM Power8 box:</i></u></span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"># avocado run multivm_cpustress.stress_suspend --vt-type libvirt --vt-extra-params create_vm_libvirt=yes kill_vm_libvirt=yes env_cleanup=yes backup_image_before_testing=no restore_image_after_testing=no vcpu_cores=2 smp=2 --vt-guest-os JeOS.27.ppc64le</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;">JOB ID&nbsp; &nbsp; &nbsp;: 080fd40cc63fb4b68057a3f3d78fe7850dc995ea</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;">JOB LOG&nbsp; &nbsp; : /home/sath/avocado-fvt-wrapper/results/job-2018-05-17T02.58-080fd40/job.log</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;">&nbsp;(1/1) type_specific.io-github-autotest-libvirt.multivm_cpustress.stress_suspend: PASS (291.43 s)</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;">RESULTS&nbsp; &nbsp; : PASS 1 | ERROR 0 | FAIL 0 | SKIP 0 | WARN 0 | INTERRUPT 0 | CANCEL 0</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;">JOB TIME&nbsp; &nbsp;: 318.42 s</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;"><br /></span> <span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;"></span><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><u><i>Result on Intel box:</i></u></span></div><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">$sudo avocado run multivm_cpustress.stress_suspend --vt-type libvirt --vt-extra-params create_vm_libvirt=yes kill_vm_libvirt=yes env_cleanup=yes backup_image_before_testing=no restore_image_after_testing=no vcpu_cores=2 smp=2</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">[sudo] password for satheesh:&nbsp;</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;">JOB ID&nbsp; &nbsp; &nbsp;: d405ea473644c411b15e85e5956064bd3784aa6b</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;">JOB LOG&nbsp; &nbsp; : /root/avocado/job-results/job-2018-05-16T12.45-d405ea4/job.log</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;">&nbsp;(1/1) type_specific.io-github-autotest-libvirt.multivm_cpustress.stress_suspend: PASS (312.76 s)</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;">RESULTS&nbsp; &nbsp; : PASS 1 | ERROR 0 | FAIL 0 | SKIP 0 | WARN 0 | INTERRUPT 0 | CANCEL 0</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;">JOB TIME&nbsp; &nbsp;: 322.33 s</span><br /><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">p:s:- <i>sudo</i> can be ignored if you are already a root user.</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif; font-size: x-small;"><i>guest image is missing wget, gcc packages, install manually.</i></span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><br /></span><i><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">It's that simple now, let me explain what this test(</span></i><i style="font-family: Times, &quot;Times New Roman&quot;, serif;">multivm_cpustress.stress_suspend</i><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">)</span><i><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">&nbsp;does in simple words!!!</span></i><br /><i><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><br /></span></i><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">1) Define and start&nbsp;</span><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">three* VMs in libvirt environment.</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">2) Runs given stress cmd inside each VM.</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">3) Suspend/Resume each VM in parallel for given number of iterations*.</span><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;"><br /></span><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">* - N</span><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">umber of VMs,&nbsp; Number of iterations of suspend/resumes are test configurable, and it can just be modified in a command line like other params e:g:-&nbsp;</span><i style="font-family: Times, &quot;Times New Roman&quot;, serif;">vcpu_cores=2</i><br /><br /><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">There are few more tests in&nbsp;</span><i style="font-family: Times, &quot;Times New Roman&quot;, serif;">multivm_cpustress </i><span style="font-family: &quot;times&quot; , &quot;times new roman&quot; , serif;">which concentrates on stress vcpu pinning, vcpu hot-plugging etc.</span><br /><br /><a name='more'></a><br /><div><br /></div><div><i><span style="color: blue;">Hope this helps you in someways!!</span></i></div><div><i><span style="color: blue;">Thanks for taking time in reading this blog....</span></i></div></div>